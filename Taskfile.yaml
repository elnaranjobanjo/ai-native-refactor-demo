version: '3'

tasks:
  setup-env:
    desc: Create Python virtual environment with testing dependencies
    cmds:
      - python3 -m venv .venv
      - ./.venv/bin/pip install --upgrade pip
      - ./.venv/bin/pip install -r requirements.txt

  biz-logic:
    desc: Document business logic for legacy code before refactoring
    cmds:
      - codex exec - < ./agent/prompts/business_logic_prompt.md

  refactor:
    desc: Run the Codex refactor prompt
    cmds:
      - codex exec - < ./agent/prompts/refactor_prompt.md

  testplan:
    desc: Generate regression test plan and pytest suites
    cmds:
      - codex exec - < ./agent/prompts/testing_prompt.md

  test:
    desc: Run pytest suite and capture output under refactored/
    deps: [setup-env]
    cmds:
      - mkdir -p refactored/tests
      - mkdir -p refactored/reasoning_artifacts
      - PYTHONPATH=. ./.venv/bin/python -m pytest refactored/tests -q | tee refactored/reasoning_artifacts/testing_results.txt

  docs:
    desc: Generate documentation for legacy vs refactored modules
    cmds:
      - codex exec - < ./agent/prompts/documentation_prompt.md

  qa:
    desc: Perform QA verification, rerun pipeline steps if needed, and generate report
    cmds:
      - codex exec - < ./agent/prompts/qa_prompt.md

  pipeline:
    desc: Run refactor, regenerate tests, execute pytest, and produce docs
    cmds:
      - task biz-logic
      - task refactor
      - task testplan
      - task test
      - task docs
      - task qa
